#!/bin/bash

PROXY_PORT=1080
HTTP_PROXY_PORT=8118
SSH_HOST=""

start_proxy() {
  # Check if already running
  if lsof -i :$PROXY_PORT &>/dev/null; then
    echo "Proxy already running on port $PROXY_PORT"
    return 1
  fi

  # Start SSH tunnel in background
  ssh -ai ~/.ssh/id_personal -D $PROXY_PORT -N -f $SSH_HOST

  if [ $? -eq 0 ]; then
    # Start Privoxy
    brew services start privoxy &>/dev/null

    echo "Proxy started on port $PROXY_PORT"
    echo "Privoxy running on port $HTTP_PROXY_PORT"
  else
    echo "Failed to start proxy"
  fi
}

stop_proxy() {
  # Kill SSH tunnel
  lsof -ti :$PROXY_PORT | xargs kill 2>/dev/null

  # Stop Privoxy
  brew services stop privoxy &>/dev/null

  echo "Proxy stopped"
}

status_proxy() {
  if lsof -i :$PROXY_PORT &>/dev/null; then
    echo "Proxy is running"
    echo "Your proxied IP:"
    curl -s --proxy http://127.0.0.1:$HTTP_PROXY_PORT https://ifconfig.me
    echo ""
    echo ""
    echo "Your current IP:"
    curl -s https://ifconfig.me
    echo ""
  else
    echo "Proxy is not running"
  fi
}

case "$1" in
  start) start_proxy ;;
  stop) stop_proxy ;;
  status) status_proxy ;;
  *) echo "Usage: $0 {start|stop|status}" ;;
esac
