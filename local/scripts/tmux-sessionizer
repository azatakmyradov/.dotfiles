#!/usr/bin/env fish

if not command -q fzf
    echo "fzf not found" 1>&2
    exit 1
end

if not command -q tmux
    echo "tmux not found" 1>&2
    exit 1
end

set -l search_paths "$HOME/personal" "$HOME/work" "$HOME"
set -l candidates

for root in $search_paths
    if test -d "$root"
        set -l found (find -- "$root" -mindepth 1 -maxdepth 1 -type d -name .git -prune -o -type d -print 2>/dev/null)
        if test (count $found) -gt 0
            set candidates $candidates $found
        end
    end
end

if test (count $candidates) -eq 0
    exit 0
end

set -l selected (printf '%s\n' $candidates | fzf)
if test -z "$selected"
    exit 0
end

# Extract parent (2nd to last component) and child (last component)
set -l parent (basename (dirname "$selected"))
set -l child (basename "$selected")

# Replace non-alphanumeric chars with underscores, trim edges
set -l parent (string replace -ra '[^A-Za-z0-9]+' '_' -- "$parent" | string trim -c '_')
set -l child (string replace -ra '[^A-Za-z0-9]+' '_' -- "$child" | string trim -c '_')

# Build session name as parent_child
set -l session "$parent"_"$child"

if test -z "$session" -o "$session" = ":"
    set session "session"
end

if tmux has-session -t "$session" 2>/dev/null
    if set -q TMUX
        tmux switch-client -t "$session"
    else
        tmux attach-session -t "$session"
    end
    exit 0
end

tmux new-session -d -s "$session" -c "$selected"
if set -q TMUX
    tmux switch-client -t "$session"
else
    tmux attach-session -t "$session"
end
